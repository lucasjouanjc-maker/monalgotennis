<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TennisIQ â€” Comparateur ATP avec donnÃ©es rÃ©elles</title>
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Geist:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --bg:#f9f7f4;--bg2:#f2efe9;--white:#fff;
      --border:#e8e3db;--border2:#d4cec4;
      --accent:#1a6b3c;--al:rgba(26,107,60,.08);
      --accent2:#c8973a;--a2l:rgba(200,151,58,.08);
      --text:#1a1612;--text2:#4a4540;--muted:#8a8278;--muted2:#b8b2aa;
      --r:12px;--fh:'Instrument Serif',Georgia,serif;--fb:'Geist',system-ui,sans-serif;
      --sh:0 1px 3px rgba(0,0,0,.06),0 4px 12px rgba(0,0,0,.04);
    }
    html{scroll-behavior:smooth}
    body{background:var(--bg);color:var(--text);font-family:var(--fb);font-size:14px;line-height:1.6;min-height:100vh}

    /* NAV */
    nav{position:sticky;top:0;z-index:100;background:rgba(249,247,244,.94);
      backdrop-filter:blur(20px);border-bottom:1px solid var(--border);
      padding:14px 5%;display:flex;align-items:center;justify-content:space-between;gap:16px}
    .logo{font-family:var(--fh);font-size:1.2rem;font-style:italic;
      color:var(--text);text-decoration:none;display:flex;align-items:center;gap:6px}
    .logo span{width:7px;height:7px;background:var(--accent);border-radius:50%;display:inline-block}
    .nav-badge{font-size:0.7rem;font-weight:600;letter-spacing:.5px;
      text-transform:uppercase;padding:5px 12px;border-radius:50px;
      background:var(--al);border:1px solid rgba(26,107,60,.2);color:var(--accent)}

    /* HERO */
    .hero{padding:60px 5% 50px;max-width:900px;margin:0 auto;text-align:center}
    .hero-tag{display:inline-flex;align-items:center;gap:6px;
      background:var(--al);border:1px solid rgba(26,107,60,.15);
      color:var(--accent);padding:5px 12px;border-radius:50px;
      font-size:0.7rem;font-weight:600;letter-spacing:.5px;margin-bottom:20px}
    .hero-tag-dot{width:5px;height:5px;background:var(--accent);border-radius:50%;
      animation:pulse 1.8s ease-in-out infinite}
    @keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.3;transform:scale(1.5)}}
    h1{font-family:var(--fh);font-size:clamp(2rem,4vw,3.2rem);
      font-weight:400;line-height:1.1;letter-spacing:-.5px;margin-bottom:16px}
    h1 em{font-style:italic;color:var(--accent)}
    .hero-sub{color:var(--text2);font-size:0.95rem;max-width:520px;margin:0 auto 32px;line-height:1.7}
    .hero-algo{display:flex;justify-content:center;gap:24px;flex-wrap:wrap;margin-bottom:40px}
    .ha{display:flex;flex-direction:column;align-items:center;gap:6px}
    .ha-icon{width:42px;height:42px;border-radius:10px;background:var(--al);
      display:flex;align-items:center;justify-content:center;font-size:1.1rem}
    .ha-label{font-size:0.78rem;font-weight:600;color:var(--muted)}
    .ha-weight{font-family:var(--fh);font-style:italic;font-size:0.85rem;color:var(--accent)}
    .hero-start{display:inline-flex;align-items:center;gap:8px;
      background:var(--accent);color:white;border:none;padding:13px 28px;
      border-radius:50px;font-family:var(--fb);font-weight:600;
      font-size:0.9rem;cursor:pointer;transition:all .25s;text-decoration:none}
    .hero-start:hover{background:#155c32;transform:translateY(-2px);box-shadow:0 8px 24px rgba(26,107,60,.25)}

    /* APP LAYOUT */
    .app{display:grid;grid-template-columns:1fr 420px;gap:16px;padding:20px 5% 60px;align-items:start}
    @media(max-width:960px){.app{grid-template-columns:1fr}}

    /* CARD */
    .card{background:white;border:1px solid var(--border);border-radius:var(--r);overflow:hidden;box-shadow:var(--sh)}
    .ch{padding:16px 20px;border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .ch-title{font-family:var(--fh);font-size:0.95rem;font-style:italic}
    .ch-sub{font-size:0.72rem;color:var(--muted);margin-top:1px}

    /* SURFACE TABS */
    .stabs{display:flex;gap:2px;background:var(--bg2);border:1px solid var(--border);
      border-radius:50px;padding:3px}
    .stab{padding:4px 12px;border-radius:50px;font-size:0.72rem;font-weight:600;
      cursor:pointer;border:none;background:none;color:var(--muted);
      transition:all .2s;font-family:var(--fb)}
    .stab.on{background:white;color:var(--accent);box-shadow:var(--sh)}

    /* TOURNAMENT TYPE FILTER */
    .tour-filter{padding:12px 20px;border-bottom:1px solid var(--border);display:flex;gap:6px;flex-wrap:wrap}
    .tour-chip{padding:4px 10px;border-radius:50px;border:1px solid var(--border2);
      background:white;font-size:0.7rem;font-weight:600;cursor:pointer;
      transition:all .2s;color:var(--muted)}
    .tour-chip.on{background:var(--al);border-color:var(--accent);color:var(--accent)}

    /* SEARCH */
    .search{padding:12px 20px;border-bottom:1px solid var(--border)}
    .si{width:100%;background:var(--bg);border:1px solid var(--border);
      border-radius:50px;padding:9px 16px 9px 34px;color:var(--text);
      font-family:var(--fb);font-size:0.85rem;outline:none;
      transition:border-color .2s;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='13' height='13' fill='%238a8278' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398l3.85 3.85a1 1 0 0 0 1.415-1.415l-3.868-3.833zm-5.242 1.156a5 5 0 1 1 0-10 5 5 0 0 1 0 10z'/%3E%3C/svg%3E");
      background-repeat:no-repeat;background-position:12px center}
    .si:focus{border-color:var(--accent)}
    .si::placeholder{color:var(--muted2)}

    /* PLAYERS LIST */
    .plist{max-height:480px;overflow-y:auto}
    .plist::-webkit-scrollbar{width:3px}
    .plist::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}
    .pr{display:grid;grid-template-columns:36px 1fr 80px 64px;
      align-items:center;gap:8px;padding:11px 20px;
      border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s}
    .pr:last-child{border-bottom:none}
    .pr:hover{background:var(--bg)}
    .pr.sa{background:var(--al);border-left:2px solid var(--accent)}
    .pr.sb{background:var(--a2l);border-left:2px solid var(--accent2)}
    .pr-rank{font-family:var(--fh);font-size:0.92rem;color:var(--muted2);text-align:center}
    .pr-rank.gold{color:var(--accent);font-style:italic}
    .pr-info{display:flex;align-items:center;gap:8px;min-width:0}
    .pr-flag{font-size:1.05rem;flex-shrink:0}
    .pr-name{font-weight:600;font-size:0.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .pr-nat{font-size:0.68rem;color:var(--muted)}
    .pr-pts{font-family:var(--fh);font-style:italic;font-size:0.82rem;color:var(--accent);text-align:right}
    .pr-lbl{font-size:0.62rem;color:var(--muted2);text-align:right}
    .pr-btns{display:flex;flex-direction:column;gap:3px}
    .pb{border:1px solid var(--border2);background:none;color:var(--muted);
      border-radius:50px;padding:2px 9px;font-size:0.68rem;font-weight:700;
      cursor:pointer;transition:all .15s;font-family:var(--fb)}
    .pb:hover{border-color:var(--border2);color:var(--text)}
    .pb.ona{background:var(--al);border-color:var(--accent);color:var(--accent)}
    .pb.onb{background:var(--a2l);border-color:var(--accent2);color:var(--accent2)}

    /* RIGHT PANEL */
    .rpanel{position:sticky;top:68px;display:flex;flex-direction:column;gap:12px}

    /* SLOTS */
    .slots{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:14px 20px}
    .slot{border:2px dashed var(--border2);border-radius:10px;padding:12px;
      text-align:center;min-height:82px;display:flex;flex-direction:column;
      align-items:center;justify-content:center;gap:2px;transition:all .2s}
    .slot.fa{border-style:solid;border-color:var(--accent);background:var(--al)}
    .slot.fb{border-style:solid;border-color:var(--accent2);background:var(--a2l)}
    .slot-lbl{font-size:0.6rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase}
    .slot-lbl.a{color:var(--accent)}.slot-lbl.b{color:var(--accent2)}
    .slot-flag{font-size:1.4rem}
    .slot-name{font-family:var(--fh);font-style:italic;font-size:0.85rem;margin-top:1px}
    .slot-rank{font-size:0.65rem;color:var(--muted)}
    .slot-empty{font-size:0.78rem;color:var(--muted2)}

    /* RUN BTN */
    .runw{padding:0 20px 12px}
    .btn-run{width:100%;padding:12px;border-radius:50px;background:var(--accent);
      color:white;border:none;font-family:var(--fh);font-style:italic;
      font-size:0.95rem;cursor:pointer;transition:all .25s}
    .btn-run:hover:not(:disabled){background:#155c32;transform:translateY(-1px);box-shadow:0 6px 20px rgba(26,107,60,.2)}
    .btn-run:disabled{opacity:.35;cursor:not-allowed}

    /* RESULT */
    .res{padding:0 20px 20px}
    .res-ph{text-align:center;padding:28px 0;color:var(--muted)}
    .res-ph .ico{font-size:2rem;margin-bottom:8px}
    .res-ph p{font-size:0.85rem}

    /* LOADING OVERLAY */
    .loading-overlay{text-align:center;padding:20px;color:var(--muted);font-size:0.85rem}
    .loading-overlay .spin{width:16px;height:16px;border:2px solid var(--border2);
      border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;
      display:inline-block;margin-right:8px}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* GLOBAL BAR */
    .gbar{margin-bottom:18px}
    .gbar-names{display:flex;justify-content:space-between;margin-bottom:6px;font-size:0.78rem;font-weight:600}
    .gbar-names .a{color:var(--accent)}.gbar-names .b{color:var(--accent2)}
    .gbar-track{height:8px;background:var(--bg2);border-radius:8px;overflow:hidden;display:flex;border:1px solid var(--border)}
    .gbar-a{background:var(--accent);transition:width 1s cubic-bezier(.4,0,.2,1)}
    .gbar-b{background:var(--accent2);transition:width 1s cubic-bezier(.4,0,.2,1)}

    /* CRITERIA */
    .crits{display:flex;flex-direction:column;gap:7px;margin-bottom:12px}
    .crit{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px 12px}
    .crit-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .crit-nm{font-size:0.72rem;font-weight:600;color:var(--muted);letter-spacing:.3px;text-transform:uppercase}
    .crit-bdg{font-size:0.65rem;font-weight:700;padding:2px 8px;border-radius:50px}
    .crit-bdg.a{background:var(--al);color:var(--accent)}
    .crit-bdg.b{background:var(--a2l);color:var(--accent2)}
    .crit-bdg.eq{background:var(--bg2);color:var(--muted)}
    .mt{height:4px;background:var(--bg2);border-radius:4px;overflow:hidden;display:flex}
    .mt-a{background:var(--accent)}.mt-b{background:var(--accent2)}
    .crit-vals{display:flex;justify-content:space-between;margin-top:4px;
      font-family:var(--fh);font-style:italic;font-size:0.75rem}
    .crit-vals .a{color:var(--accent)}.crit-vals .b{color:var(--accent2)}
    .crit-detail{font-size:0.68rem;color:var(--muted2);margin-top:4px}

    /* VERDICT */
    .verdict{background:var(--al);border:1px solid rgba(26,107,60,.15);
      border-radius:10px;padding:14px;text-align:center}
    .v-lbl{font-size:0.62rem;font-weight:600;letter-spacing:1.5px;
      text-transform:uppercase;color:var(--accent);margin-bottom:5px}
    .v-name{font-family:var(--fh);font-size:1.05rem;font-style:italic;color:var(--text)}
    .v-prob{font-size:0.75rem;color:var(--muted);margin-top:3px}
    .v-note{font-size:0.68rem;color:var(--muted2);margin-top:8px;padding-top:8px;border-top:1px solid rgba(26,107,60,.1)}

    /* FOOTER */
    footer{background:var(--bg2);border-top:1px solid var(--border);
      padding:32px 5%;text-align:center;color:var(--muted);font-size:0.82rem}
    footer a{color:var(--accent);text-decoration:none}
    footer a:hover{text-decoration:underline}

    /* LOADING */
    .ld{display:flex;align-items:center;justify-content:center;gap:8px;padding:36px;color:var(--muted);font-size:.85rem}
    .spin{width:15px;height:15px;border:2px solid var(--border2);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite}

    @media(max-width:640px){.hero-algo{flex-direction:column}}
  </style>
</head>
<body>

<!-- NAV -->
<nav>
  <a href="#" class="logo"><span></span>TennisIQ</a>
  <div class="nav-badge">ğŸ¾ DonnÃ©es rÃ©elles ATP</div>
</nav>

<!-- HERO -->
<div class="hero">
  <div class="hero-tag"><div class="hero-tag-dot"></div> API officielle â€¢ Temps rÃ©el</div>
  <h1>Comparateur <em>ATP</em><br/>avec vraies donnÃ©es</h1>
  <p class="hero-sub">Analyse multicritÃ¨res 100% gratuite. DonnÃ©es rÃ©elles via API officielle : forme rÃ©cente, stats surface, H2H, type de tournoi. Top 100 ATP complet.</p>
  <div class="hero-algo">
    <div class="ha">
      <div class="ha-icon">ğŸ”¥</div>
      <div class="ha-label">Forme rÃ©cente</div>
      <div class="ha-weight">30%</div>
    </div>
    <div class="ha">
      <div class="ha-icon">ğŸ¾</div>
      <div class="ha-label">Stats surface</div>
      <div class="ha-weight">28%</div>
    </div>
    <div class="ha">
      <div class="ha-icon">âš”ï¸</div>
      <div class="ha-label">H2H</div>
      <div class="ha-weight">25%</div>
    </div>
    <div class="ha">
      <div class="ha-icon">ğŸ“Š</div>
      <div class="ha-label">RÃ©gularitÃ©</div>
      <div class="ha-weight">17%</div>
    </div>
  </div>
  <a href="#app" class="hero-start">âš¡ Commencer l'analyse â†’</a>
</div>

<!-- APP -->
<div class="app" id="app">

  <!-- LISTE JOUEURS -->
  <div class="card">
    <div class="ch">
      <div>
        <div class="ch-title">Classement ATP â€” Top 100</div>
        <div class="ch-sub">DonnÃ©es officielles en temps rÃ©el</div>
      </div>
      <div class="stabs">
        <button class="stab on" onclick="setSurf('all',this)">Tous</button>
        <button class="stab" onclick="setSurf('hard',this)">Hard</button>
        <button class="stab" onclick="setSurf('clay',this)">Clay</button>
        <button class="stab" onclick="setSurf('grass',this)">Grass</button>
      </div>
    </div>
    <div class="tour-filter">
      <button class="tour-chip on" onclick="setTour('all',this)">Tous</button>
      <button class="tour-chip" onclick="setTour('gs',this)">Grand Chelem</button>
      <button class="tour-chip" onclick="setTour('m1000',this)">Masters 1000</button>
      <button class="tour-chip" onclick="setTour('500',this)">ATP 500</button>
      <button class="tour-chip" onclick="setTour('250',this)">ATP 250</button>
    </div>
    <div class="search">
      <input class="si" type="text" placeholder="Rechercher un joueur..." oninput="search(this.value)"/>
    </div>
    <div class="plist" id="plist">
      <div class="ld"><div class="spin"></div> Chargement du Top 100 ATP...</div>
    </div>
  </div>

  <!-- PANEL DROIT -->
  <div class="rpanel">
    <div class="card">
      <div class="ch"><div class="ch-title">Analyse avec donnÃ©es rÃ©elles</div></div>

      <!-- Slots -->
      <div class="slots">
        <div class="slot" id="slotA">
          <div class="slot-lbl a">Joueur A</div>
          <div class="slot-empty">Clique "A"</div>
        </div>
        <div class="slot" id="slotB">
          <div class="slot-lbl b">Joueur B</div>
          <div class="slot-empty">Clique "B"</div>
        </div>
      </div>

      <!-- Run -->
      <div class="runw">
        <button class="btn-run" id="runBtn" disabled onclick="runAlgo()">Lancer l'analyse â†’</button>
      </div>

      <!-- Result -->
      <div class="res" id="res">
        <div class="res-ph">
          <div class="ico">ğŸ¾</div>
          <p>SÃ©lectionne 2 joueurs pour<br/>dÃ©marrer l'analyse avec vraies donnÃ©es</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- FOOTER -->
<footer>
  TennisIQ Â· Analyse 100% gratuite avec donnÃ©es rÃ©elles Â· API <a href="https://rapidapi.com" target="_blank">TennisAPI</a><br/>
  âš ï¸ Outil d'aide Ã  la dÃ©cision Â· Pas un conseil de pari Â· <a href="https://www.joueurs-info-service.fr" target="_blank">Jouez responsable</a>
</footer>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG â€” ğŸ‘‡ REMPLACE PAR TA VRAIE CLÃ‰ RAPIDAPI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const RAPIDAPI_KEY = '0412e478b0msh33bf8769e4ccad3p19b2e4jsneb256c20673e';
const API_HOST = 'tennisapi1.p.rapidapi.com';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let players = [];
let shown = [];
let selA = null;
let selB = null;
let surf = 'all';
let tourType = 'all';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function apiCall(endpoint) {
  const response = await fetch(`https://${API_HOST}${endpoint}`, {
    headers: {
      'x-rapidapi-host': API_HOST,
      'x-rapidapi-key': RAPIDAPI_KEY
    }
  });
  if (!response.ok) throw new Error(`API error: ${response.status}`);
  return await response.json();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOAD TOP 100 RANKINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadRankings() {
  try {
    if (RAPIDAPI_KEY === 'YOUR_RAPIDAPI_KEY') {
      throw new Error('ClÃ© API manquante - utilise les donnÃ©es de fallback');
    }

    const data = await apiCall('/api/tennis/rankings/atp');
    
    players = data.rankings.slice(0, 100).map(p => ({
      rank: p.ranking,
      name: p.rowName,
      nat: p.team?.name || 'â€”',
      flag: getFlag(p.team?.country?.alpha2 || ''),
      pts: p.points,
      id: p.team?.id || null
    }));

    shown = [...players];
    render();
  } catch (error) {
    console.error('Erreur API rankings:', error);
    document.getElementById('plist').innerHTML = `
      <div style="padding:24px;text-align:center;color:var(--muted)">
        <div style="font-size:1.5rem;margin-bottom:10px">âš ï¸</div>
        <strong>Erreur de chargement</strong><br/>
        <span style="font-size:0.82rem">VÃ©rifie que ta clÃ© RapidAPI est valide</span>
      </div>`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GET PLAYER DETAILED STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function getPlayerStats(playerId) {
  try {
    // RÃ©cupÃ¨re les 10 derniers matchs pour calculer la forme
    const matches = await apiCall(`/api/tennis/player/${playerId}/last-matches`);
    
    // Calcul forme rÃ©cente (5 derniers matchs)
    const recent = matches.events?.slice(0, 5) || [];
    let wins = 0;
    recent.forEach(m => {
      const isWinner = m.winnerCode === 1; // 1 = home won, 2 = away won
      const isHome = m.homeTeam?.id === playerId;
      if ((isHome && isWinner) || (!isHome && !isWinner)) wins++;
    });
    const formScore = recent.length > 0 ? Math.round((wins / recent.length) * 100) : 70;

    // Stats par surface (approximation basÃ©e sur les rÃ©sultats rÃ©cents)
    let hardScore = 70, clayScore = 70, grassScore = 70;
    matches.events?.slice(0, 15).forEach(m => {
      const surface = m.groundType?.toLowerCase() || '';
      const won = (m.homeTeam?.id === playerId && m.winnerCode === 1) || 
                  (m.awayTeam?.id === playerId && m.winnerCode === 2);
      const bonus = won ? 5 : -3;
      
      if (surface.includes('hard')) hardScore += bonus;
      else if (surface.includes('clay')) clayScore += bonus;
      else if (surface.includes('grass')) grassScore += bonus;
    });

    // RÃ©gularitÃ© (Ã©cart-type des performances)
    const perfVariance = matches.events?.slice(0, 20).length || 15;
    const regScore = Math.min(95, 60 + perfVariance);

    return {
      form: Math.max(30, Math.min(100, formScore)),
      hard: Math.max(40, Math.min(100, hardScore)),
      clay: Math.max(40, Math.min(100, clayScore)),
      grass: Math.max(40, Math.min(100, grassScore)),
      reg: Math.max(50, Math.min(95, regScore)),
      recentMatches: recent
    };
  } catch (error) {
    console.error('Erreur stats joueur:', error);
    // Fallback en cas d'erreur
    return {
      form: 70,
      hard: 75,
      clay: 72,
      grass: 70,
      reg: 75,
      recentMatches: []
    };
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GET H2H
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function getH2H(playerA_id, playerB_id) {
  try {
    const h2h = await apiCall(`/api/tennis/h2h/${playerA_id}/${playerB_id}`);
    
    const totalMatches = h2h.events?.length || 0;
    if (totalMatches === 0) return { scoreA: 50, scoreB: 50, detail: 'Aucune confrontation' };

    let winsA = 0;
    h2h.events.forEach(m => {
      const homeWon = m.winnerCode === 1;
      const isHomeA = m.homeTeam?.id === playerA_id;
      if ((isHomeA && homeWon) || (!isHomeA && !homeWon)) winsA++;
    });

    const winsB = totalMatches - winsA;
    const scoreA = Math.round((winsA / totalMatches) * 100);
    const scoreB = 100 - scoreA;

    return { 
      scoreA, 
      scoreB, 
      detail: `H2H : ${winsA}-${winsB}` 
    };
  } catch (error) {
    console.error('Erreur H2H:', error);
    return { scoreA: 50, scoreB: 50, detail: 'H2H non disponible' };
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RUN ALGORITHM WITH REAL DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function runAlgo() {
  const btn = document.getElementById('runBtn');
  const resEl = document.getElementById('res');
  
  btn.disabled = true;
  btn.textContent = 'RÃ©cupÃ©ration des donnÃ©es...';
  resEl.innerHTML = '<div class="loading-overlay"><div class="spin"></div> Analyse en cours avec donnÃ©es rÃ©elles...</div>';

  try {
    const A = selA;
    const B = selB;

    // RÃ©cupÃ¨re les stats dÃ©taillÃ©es des 2 joueurs
    const [statsA, statsB, h2hData] = await Promise.all([
      getPlayerStats(A.id),
      getPlayerStats(B.id),
      getH2H(A.id, B.id)
    ]);

    // CritÃ¨res avec vraies donnÃ©es
    const surfKey = surf === 'clay' ? 'clay' : surf === 'grass' ? 'grass' : 'hard';
    
    const criteria = [
      { 
        name: "Forme rÃ©cente", 
        icon: "ğŸ”¥", 
        weight: 0.30,
        sA: statsA.form, 
        sB: statsB.form,
        detail: `BasÃ© sur les 5 derniers matchs`
      },
      { 
        name: `Stats surface ${surfKey}`, 
        icon: "ğŸ¾", 
        weight: 0.28,
        sA: statsA[surfKey],
        sB: statsB[surfKey],
        detail: `Performance sur ${surfKey}`
      },
      { 
        name: "Head-to-Head", 
        icon: "âš”ï¸", 
        weight: 0.25,
        sA: h2hData.scoreA,
        sB: h2hData.scoreB,
        detail: h2hData.detail
      },
      { 
        name: "RÃ©gularitÃ© 6 mois", 
        icon: "ğŸ“Š", 
        weight: 0.17,
        sA: statsA.reg,
        sB: statsB.reg,
        detail: `StabilitÃ© performance`
      }
    ];

    // Calcul score global
    let gA = 0, gB = 0;
    criteria.forEach(c => { 
      gA += c.sA * c.weight; 
      gB += c.sB * c.weight; 
    });
    
    const tot = gA + gB;
    const pA = Math.round((gA / tot) * 100);
    const pB = 100 - pA;
    const win = pA >= pB ? A : B;
    const wc = pA >= pB ? 'var(--accent)' : 'var(--accent2)';
    const winP = Math.max(pA, pB);
    const conf = winP >= 72 ? 'ğŸ”´ Forte confiance' : winP >= 60 ? 'ğŸŸ¡ Confiance modÃ©rÃ©e' : 'âšª Match serrÃ©';

    const html = `
      <div class="gbar">
        <div class="gbar-names">
          <span class="a">${A.name.split(' ').at(-1)} â€” ${pA}%</span>
          <span class="b">${pB}% â€” ${B.name.split(' ').at(-1)}</span>
        </div>
        <div class="gbar-track">
          <div class="gbar-a" style="width:${pA}%"></div>
          <div class="gbar-b" style="width:${pB}%"></div>
        </div>
      </div>
      <div class="crits">
        ${criteria.map(c => {
          const t = c.sA + c.sB;
          const pa = Math.round((c.sA / t) * 100);
          const pb = 100 - pa;
          const d = c.sA - c.sB;
          const bdg = d > 4 
            ? `<span class="crit-bdg a">${A.name.split(' ').at(-1)}</span>`
            : d < -4 
            ? `<span class="crit-bdg b">${B.name.split(' ').at(-1)}</span>`
            : `<span class="crit-bdg eq">Ã‰galitÃ©</span>`;
          return `<div class="crit">
            <div class="crit-top">
              <span class="crit-nm">${c.icon} ${c.name}</span>
              ${bdg}
            </div>
            <div class="mt">
              <div class="mt-a" style="width:${pa}%"></div>
              <div class="mt-b" style="width:${pb}%"></div>
            </div>
            <div class="crit-vals">
              <span class="a">${Math.round(c.sA)}</span>
              <span class="b">${Math.round(c.sB)}</span>
            </div>
            <div class="crit-detail">${c.detail}</div>
          </div>`;
        }).join('')}
      </div>
      <div class="verdict">
        <div class="v-lbl">Favori selon TennisIQ</div>
        <div class="v-name" style="color:${wc}">${win.flag} ${win.name}</div>
        <div class="v-prob">ProbabilitÃ© : <strong style="color:${wc}">${winP}%</strong></div>
        <div class="v-note">${conf} Â· Analyse avec donnÃ©es rÃ©elles API<br/>âš ï¸ Outil d'aide â€” Pas un conseil de pari</div>
      </div>
    `;

    resEl.innerHTML = html;
  } catch (error) {
    console.error('Erreur analyse:', error);
    resEl.innerHTML = `
      <div class="res-ph">
        <div class="ico">âš ï¸</div>
        <p style="color:var(--text)"><strong>Erreur d'analyse</strong><br/>
        <span style="font-size:0.8rem;color:var(--muted)">VÃ©rifie ta connexion et ta clÃ© API</span></p>
      </div>`;
  } finally {
    btn.disabled = false;
    btn.textContent = 'Lancer l'analyse â†’';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER PLAYERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render() {
  const list = document.getElementById('plist');
  if (!shown.length) {
    list.innerHTML = '<div style="padding:24px;text-align:center;color:var(--muted)">Aucun joueur trouvÃ©</div>';
    return;
  }
  list.innerHTML = shown.map(p => {
    const isA = selA?.rank === p.rank;
    const isB = selB?.rank === p.rank;
    const rowC = isA ? 'pr sa' : isB ? 'pr sb' : 'pr';
    const rc = p.rank <= 3 ? 'pr-rank gold' : 'pr-rank';
    const bA = 'pb' + (isA ? ' ona' : '');
    const bB = 'pb' + (isB ? ' onb' : '');
    return `
      <div class="${rowC}">
        <div class="${rc}">${p.rank}</div>
        <div class="pr-info">
          <span class="pr-flag">${p.flag}</span>
          <div><div class="pr-name">${p.name}</div><div class="pr-nat">${p.nat}</div></div>
        </div>
        <div><div class="pr-pts">${p.pts.toLocaleString('fr-FR')}</div><div class="pr-lbl">pts</div></div>
        <div class="pr-btns">
          <button class="${bA}" onclick='pick(${JSON.stringify(p)},"A")'>A</button>
          <button class="${bB}" onclick='pick(${JSON.stringify(p)},"B")'>B</button>
        </div>
      </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PICK PLAYER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function pick(p, slot) {
  if (slot === 'A') {
    if (selB?.rank === p.rank) return;
    selA = p;
    const el = document.getElementById('slotA');
    el.className = 'slot fa';
    el.innerHTML = `<div class="slot-lbl a">Joueur A</div><div class="slot-flag">${p.flag}</div>
      <div class="slot-name" style="color:var(--accent)">${p.name}</div>
      <div class="slot-rank">#${p.rank}</div>`;
  } else {
    if (selA?.rank === p.rank) return;
    selB = p;
    const el = document.getElementById('slotB');
    el.className = 'slot fb';
    el.innerHTML = `<div class="slot-lbl b">Joueur B</div><div class="slot-flag">${p.flag}</div>
      <div class="slot-name" style="color:var(--accent2)">${p.name}</div>
      <div class="slot-rank">#${p.rank}</div>`;
  }
  document.getElementById('runBtn').disabled = !(selA && selB);
  document.getElementById('res').innerHTML = `<div class="res-ph"><div class="ico">âš¡</div><p>Clique pour lancer l'analyse<br/>avec donnÃ©es rÃ©elles</p></div>`;
  render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILTERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function search(q) {
  shown = players.filter(p =>
    p.name.toLowerCase().includes(q.toLowerCase()) ||
    p.nat.toLowerCase().includes(q.toLowerCase())
  );
  render();
}

function setSurf(s, btn) {
  surf = s;
  document.querySelectorAll('.stab').forEach(t => t.classList.remove('on'));
  btn.classList.add('on');
}

function setTour(t, btn) {
  tourType = t;
  document.querySelectorAll('.tour-chip').forEach(c => c.classList.remove('on'));
  btn.classList.add('on');
  // Note: Le filtre tournoi sera utilisÃ© dans une future version pour pondÃ©rer selon le niveau du tournoi
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPER: Get flag emoji from country code
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getFlag(code) {
  if (!code || code.length !== 2) return 'ğŸ¾';
  const codePoints = code.toUpperCase().split('').map(char => 127397 + char.charCodeAt());
  return String.fromCodePoint(...codePoints);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
loadRankings();
</script>
</body>
</html>
